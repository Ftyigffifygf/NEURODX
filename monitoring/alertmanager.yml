global:
  smtp_smarthost: "localhost:587"
  smtp_from: "alerts@neurodx.example.com"
  smtp_auth_username: "alerts@neurodx.example.com"
  smtp_auth_password: "your_email_password"

# Routing configuration
route:
  group_by: ["alertname", "service"]
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: "web.hook"
  routes:
    # Critical alerts go to on-call team immediately
    - match:
        severity: critical
      receiver: "critical-alerts"
      group_wait: 0s
      repeat_interval: 5m

    # Warning alerts go to development team
    - match:
        severity: warning
      receiver: "warning-alerts"
      repeat_interval: 30m

    # Info alerts go to business team
    - match:
        severity: info
      receiver: "info-alerts"
      repeat_interval: 4h

    # Security alerts go to security team
    - match:
        service: security
      receiver: "security-alerts"
      group_wait: 0s
      repeat_interval: 15m

# Inhibition rules to prevent alert spam
inhibit_rules:
  # If API service is down, don't alert on high error rates
  - source_match:
      alertname: APIServiceDown
    target_match:
      service: neurodx-api
    equal: ["instance"]

  # If system is down, don't alert on service-specific issues
  - source_match:
      severity: critical
      service: system
    target_match:
      severity: warning
    equal: ["instance"]

# Receiver configurations
receivers:
  - name: "web.hook"
    webhook_configs:
      - url: "http://neurodx-api:5000/api/alerts/webhook"
        send_resolved: true

  - name: "critical-alerts"
    email_configs:
      - to: "oncall@neurodx.example.com"
        subject: "[CRITICAL] NeuroDx Alert: {{ .GroupLabels.alertname }}"
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Severity: {{ .Labels.severity }}
          Started: {{ .StartsAt }}
          {{ end }}
        headers:
          Priority: "high"

    slack_configs:
      - api_url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
        channel: "#critical-alerts"
        title: "Critical Alert: {{ .GroupLabels.alertname }}"
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          *Started:* {{ .StartsAt }}
          {{ end }}
        color: "danger"

    pagerduty_configs:
      - routing_key: "your_pagerduty_integration_key"
        description: "{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.summary }}"
        severity: "critical"

  - name: "warning-alerts"
    email_configs:
      - to: "dev-team@neurodx.example.com"
        subject: "[WARNING] NeuroDx Alert: {{ .GroupLabels.alertname }}"
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Severity: {{ .Labels.severity }}
          Started: {{ .StartsAt }}
          {{ end }}

    slack_configs:
      - api_url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
        channel: "#dev-alerts"
        title: "Warning: {{ .GroupLabels.alertname }}"
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}
        color: "warning"

  - name: "info-alerts"
    email_configs:
      - to: "business-team@neurodx.example.com"
        subject: "[INFO] NeuroDx Alert: {{ .GroupLabels.alertname }}"
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Started: {{ .StartsAt }}
          {{ end }}

  - name: "security-alerts"
    email_configs:
      - to: "security-team@neurodx.example.com"
        subject: "[SECURITY] NeuroDx Alert: {{ .GroupLabels.alertname }}"
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Severity: {{ .Labels.severity }}
          Started: {{ .StartsAt }}
          {{ end }}
        headers:
          Priority: "high"

    slack_configs:
      - api_url: "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
        channel: "#security-alerts"
        title: "Security Alert: {{ .GroupLabels.alertname }}"
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}
        color: "danger"

# Templates for custom formatting
templates:
  - "/etc/alertmanager/templates/*.tmpl"
